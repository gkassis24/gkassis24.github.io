<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance Data Viewer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            text-align: center;
        }

        h1 {
            background-color: #00796b;
            color: white;
            padding: 20px;
            margin: 0;
        }

        input[type="file"] {
            display: block;
            margin: 20px auto;
            font-size: 16px;
            padding: 10px;
            border: 2px solid #00796b;
            border-radius: 5px;
            cursor: pointer;
        }

        .navigation-buttons {
            margin: 20px 0;
        }

        .button {
            background-color: #00796b;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        .button:hover {
            background-color: #004d40;
        }

        .plot-container {
            width: 80%;
            height: 300px;
            margin: 20px auto;
        }

        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #00796b;
        }

        .loading:before {
            content: '';
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid #00796b;
            border-radius: 50%;
            border-top: 5px solid transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .plot-container {
                width: 100%;
                height: 200px;
            }

            .button {
                padding: 8px 16px;
                font-size: 14px;
            }
        }

        /* Add styles for new input and button */
        #snInput {
            display: block;
            margin: 20px auto;
            font-size: 16px;
            padding: 10px;
            border: 2px solid #00796b;
            border-radius: 5px;
            width: 80%;
            max-width: 400px;
        }

        #applySnList {
            display: block;
            margin: 10px auto;
            background-color: #00796b;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        #applySnList:hover {
            background-color: #004d40;
        }

        #sheetNameInput {
            display: block;
            margin: 20px auto;
            font-size: 16px;
            padding: 10px;
            border: 2px solid #00796b;
            border-radius: 5px;
            width: 80%;
            max-width: 400px;
        }

    </style>
</head>
<body>
    <h1>Maintenance Data Viewer</h1>
    <input type="text" id="sheetNameInput" placeholder="Enter Sheet Name" />
    <input type="text" id="snInput" placeholder="Enter SNs (comma separated)" />
    <button id="applySnList" class="button">Apply SN List</button>
    <input type="file" id="fileInput" />
    <div class="navigation-buttons">
        <button id="toStart" class="button"><< Start</button>
        <button id="prevButton" class="button">Previous</button>
        <button id="nextButton" class="button">Next</button>
        <button id="toEnd" class="button">End >></button>
    </div>
    <div id="plots"></div>
    <div id="loading" class="loading">Loading...</div>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        let maintenanceData = {};
        let snList = []; // Initially empty
        const maintenanceTypes = ["Cleaned", "Arm Power Cycle", "Full Power Cycle", "Touch-up Paint"];
        let allDates = [];
        let currentStartIdx = 0;

        document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);
        document.getElementById('applySnList').addEventListener('click', applySnList);

        let snApplied = false; // Flag to check if SNs have been applied

        function applySnList() {
            const snInput = document.getElementById('snInput').value;
            if (snInput.trim() === '') {
                alert('Please enter at least one SN!');
                return;
            }
            snList = snInput.split(',').map(sn => sn.trim());
            if (snList.length === 0) {
                alert('No valid SNs provided!');
                return;
            }
            snApplied = true; // Set the flag to true once SNs are applied
            alert('SNs applied successfully!');
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                alert('Please select a file!');
                return;
            }

            if (!snApplied) { // Check if SNs have been applied
                alert('Please apply SNs before selecting a file!');
                event.target.value = ''; // Clear file input
                return;
            }

            showLoading(true); // Show loading icon

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // Get the sheet name from user input
                const sheetName = document.getElementById('sheetNameInput').value.trim();
                if (!sheetName || !workbook.SheetNames.includes(sheetName)) {
                    alert('Invalid sheet name!');
                    showLoading(false); // Hide loading icon
                    return;
                }
                
                const sheet = workbook.Sheets[sheetName];
                
                // Get formatted data from the sheet
                const formattedData = getFormattedSheetData(sheet);

                processData(formattedData);
                createPlots(currentStartIdx);
                showLoading(false); // Hide loading icon
            };
            reader.readAsArrayBuffer(file);
        }

        function getFormattedSheetData(sheet) {
            const sheetData = [];
            const range = XLSX.utils.decode_range(sheet['!ref']);

            for (let row = range.s.r; row <= range.e.r; row++) {
                const rowData = [];
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = { c: col, r: row };
                    const cellRef = XLSX.utils.encode_cell(cellAddress);
                    const cell = sheet[cellRef];
                    rowData.push(cell ? cell.w : ''); // Get formatted value or empty string
                }
                sheetData.push(rowData);
            }

            return sheetData;
        }

        function getFormattedSheetData(sheet) {
            const sheetData = [];
            const range = XLSX.utils.decode_range(sheet['!ref']);

            for (let row = range.s.r; row <= range.e.r; row++) {
                const rowData = [];
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = { c: col, r: row };
                    const cellRef = XLSX.utils.encode_cell(cellAddress);
                    const cell = sheet[cellRef];
                    rowData.push(cell ? cell.w : ''); // Get formatted value or empty string
                }
                sheetData.push(rowData);
            }

            return sheetData;
        }

        function processData(data) {
            const headers = data[0];
            const dateIndex = headers.indexOf('Date');
            
            snList.forEach(sn => {
                maintenanceTypes.forEach(type => {
                    const colName = `Daily PMCS Completed [${sn}]`;
                    const colIndex = headers.indexOf(colName);
                    if (colIndex === -1) return;

                    data.slice(1).forEach(row => {
                        const date = new Date(row[dateIndex]).toISOString().split('T')[0];
                        if (!maintenanceData[date]) maintenanceData[date] = {};

                        if (!maintenanceData[date][type]) maintenanceData[date][type] = {};
                        if (!maintenanceData[date][type][sn]) maintenanceData[date][type][sn] = 0;

                        const cellValue = row[colIndex];
                        if (cellValue && cellValue.includes(type)) {
                            maintenanceData[date][type][sn]++;
                        }
                    });
                });
            });

            allDates = Object.keys(maintenanceData).sort();
            currentStartIdx = 0; // Reset to start
            updateNavigationButtons();
            document.getElementById('prevButton').addEventListener('click', () => {
                if (currentStartIdx > 0) {
                    currentStartIdx -= 14;
                    createPlots(currentStartIdx);
                }
            });
            document.getElementById('nextButton').addEventListener('click', () => {
                if (currentStartIdx + 14 < allDates.length) {
                    currentStartIdx += 14;
                    createPlots(currentStartIdx);
                }
            });
            document.getElementById('toStart').addEventListener('click', () => {
                currentStartIdx = 0;
                createPlots(currentStartIdx);
            });
            document.getElementById('toEnd').addEventListener('click', () => {
                currentStartIdx = Math.max(allDates.length - 14, 0);
                createPlots(currentStartIdx);
            });
        }
        function createPlots(startIdx) {
            showLoading(true); // Show loading icon
            const endIdx = startIdx + 14;
            const selectedDates = allDates.slice(startIdx, endIdx);

            const plotData = maintenanceTypes.map(type => {
                const traces = snList.map(sn => {
                    return {
                        x: selectedDates,
                        y: selectedDates.map(date => maintenanceData[date] && maintenanceData[date][type] && maintenanceData[date][type][sn] || 0),
                        name: sn,
                        type: 'bar'
                    };
                });

                return {
                    title: `${type} Completion by Date`,
                    traces: traces
                };
            });

            const plotsContainer = document.getElementById('plots');
            plotsContainer.innerHTML = '';
            plotData.forEach((plot, index) => {
                const divId = `plot${index}`;
                const div = document.createElement('div');
                div.id = divId;
                div.className = 'plot-container'; // Added class for styling
                plotsContainer.appendChild(div);

                // Create a list of all dates within the range, including those without data
                const allDatesInRange = getAllDatesInRange(new Date(selectedDates[0]), new Date(selectedDates[selectedDates.length - 1]));

                Plotly.newPlot(divId, plot.traces, {
                    title: plot.title,
                    barmode: 'stack',
                    xaxis: {
                        title: '',  // Remove the title from x-axis
                        tickvals: allDatesInRange,
                        ticktext: allDatesInRange.map(date => new Date(date).toLocaleDateString()),
                        showgrid: true,  // Show grid lines if desired
                        zeroline: false  // Hide the zero line if needed
                    },
                    yaxis: {
                        title: 'Count', 
                        visible: false  // Hide y-axis labels
                    }
                });

                // Annotate bars
                plot.traces.forEach((trace, traceIndex) => {
                    trace.y.forEach((value, idx) => {
                        if (value > 0) {
                            Plotly.restyle(divId, 'text', [[...trace.y.map(v => v > 0 ? v : '')]], traceIndex);
                            Plotly.restyle(divId, 'textposition', [['inside']], traceIndex);
                        }
                    });
                });
            });

            showLoading(false); // Hide loading icon
            updateNavigationButtons();
        }


        function getAllDatesInRange(startDate, endDate) {
            const dates = [];
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                dates.push(new Date(currentDate).toISOString().split('T')[0]);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        function updateNavigationButtons() {
            document.getElementById('prevButton').style.display = currentStartIdx > 0 ? 'inline-block' : 'none';
            document.getElementById('nextButton').style.display = currentStartIdx + 14 < allDates.length ? 'inline-block' : 'none';
            document.getElementById('toStart').style.display = currentStartIdx > 0 ? 'inline-block' : 'none';
            document.getElementById('toEnd').style.display = currentStartIdx + 14 < allDates.length ? 'inline-block' : 'none';
        }

        function showLoading(show) {
            const loadingIcon = document.getElementById('loading');
            loadingIcon.style.display = show ? 'block' : 'none';
        }

    </script>
</body>
</html>
